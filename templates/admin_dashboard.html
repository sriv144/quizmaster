{% extends "base.html" %}
{% block title %}Admin Dashboard - Quiz Master{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-light rounded shadow-sm mb-4">
  <div class="container-fluid">
    <ul class="navbar-nav me-auto">
      <li class="nav-item"><a class="nav-link" href="{{ url_for('app_routes.admin_dashboard') }}">Home</a></li>
      <li class="nav-item"><a class="nav-link" href="{{ url_for('app_routes.quiz_management') }}">Quiz</a></li>
      <li class="nav-item"><a class="nav-link" href="{{ url_for('app_routes.admin_summary') }}">Summary</a></li>
      <li class="nav-item"><a class="nav-link" href="{{ url_for('app_routes.logout') }}">Logout</a></li>
    </ul>
    <div class="d-flex">
      <input id="liveSearch" class="form-control me-2" type="search" placeholder="Search subjects/chapters/quizzes">
    </div>
  </div>
</nav>

<h2 class="text-white mb-4">Welcome Admin</h2>
<div class="row" id="subjects-container">
  {% for subject in subjects %}
  <div class="col-md-6 mb-4 subject-card" data-subject-name="{{ subject.name.lower() }}">
    <div class="p-3 border rounded">
      <h4 class="text-white">{{ subject.name }}</h4>
      <table class="table table-bordered table-sm">
        <thead class="table-dark">
          <tr>
            <th class="text-white">Chapter Name</th>
            <th class="text-white"># Questions</th>
            <th class="text-white">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for chap in subject.chapters %}
          <tr class="chapter-row" data-chapter-name="{{ chap.name.lower() }}">
            <td class="text-white">{{ chap.name }}</td>
            <td class="text-white">{{ chap.questions_count }}</td>
            <td>
              <div class="d-grid d-md-inline-flex gap-2">
                <a href="{{ url_for('app_routes.edit_chapter', chapter_id=chap.id) }}" class="btn btn-info btn-sm">Edit</a>
                <form method="POST" action="{{ url_for('app_routes.delete_chapter', chapter_id=chap.id) }}" class="d-inline">
                  <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="text-end">
        <a href="{{ url_for('app_routes.add_chapter') }}?subject_id={{ subject.id }}" class="btn btn-primary btn-sm">+ Chapter</a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
<div class="mt-3">
  <a href="{{ url_for('app_routes.add_subject') }}" class="btn btn-success btn-sm">+ Subject</a>
</div>

<script>
  // Live search functionality
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('liveSearch');
    const subjectCards = document.querySelectorAll('.subject-card');
    const subjectsContainer = document.getElementById('subjects-container');
    
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.trim().toLowerCase();
      let matchFound = false;
      
      subjectCards.forEach(card => {
        const subjectName = card.getAttribute('data-subject-name');
        const chapterRows = card.querySelectorAll('.chapter-row');
        let subjectHasMatch = subjectName.includes(searchTerm);
        let anyChapterMatches = false;
        
        // Check each chapter within the subject
        chapterRows.forEach(row => {
          const chapterName = row.getAttribute('data-chapter-name');
          if (chapterName.includes(searchTerm)) {
            anyChapterMatches = true;
            row.style.display = '';
          } else if (searchTerm) {
            row.style.display = 'none';
          } else {
            row.style.display = '';
          }
        });
        
        // Show/hide the subject card based on matches
        if (subjectHasMatch || anyChapterMatches || !searchTerm) {
          card.style.display = '';
          matchFound = true;
        } else {
          card.style.display = 'none';
        }
      });
      
      // Show "no results" message if needed
      const noResultsMsg = document.querySelector('.no-results-message');
      
      if (!matchFound && searchTerm !== '') {
        if (!noResultsMsg) {
          const message = document.createElement('div');
          message.className = 'alert alert-info no-results-message mt-3';
          message.textContent = 'No subjects or chapters found matching your search.';
          subjectsContainer.appendChild(message);
        }
      } else if (noResultsMsg) {
        noResultsMsg.remove();
      }
    });
  });
</script>
{% endblock %}
