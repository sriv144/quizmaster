{% extends "base.html" %}

{% block title %}Attempt Quiz{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark custom-nav">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{{ url_for('app_routes.user_dashboard') }}">Quiz Master</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMain">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('app_routes.user_dashboard') }}">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('app_routes.user_scores') }}">Scores</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('app_routes.user_summary') }}">Summary</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('app_routes.logout') }}">Logout</a></li>
      </ul>
      <div class="text-white fw-bold" id="quizTimerContainer">
        <span id="quizTimer">00:00</span>
      </div>
    </div>
  </div>
</nav>

<!-- Add some top margin so the title is not hidden behind the navbar -->
<div class="mt-5 text-center mb-4">
  <h2 class="text-white fw-bold">Quiz: {{ quiz.name or ('Quiz #' ~ quiz.id) }}</h2>
</div>

<!-- Hidden form for timeout redirect -->
<form id="timeoutForm" action="{{ url_for('app_routes.quiz_timeout') }}" method="POST" style="display: none;">
  <input type="hidden" name="quiz_id" value="{{ quiz.id }}">
</form>

<!-- Question Navigation Box -->
<div class="card mb-4">
  <div class="card-header bg-dark text-white">
    <h5 class="mb-0">Question Navigation</h5>
  </div>
  <div class="card-body">
    <div class="d-flex flex-wrap gap-2 justify-content-center">
      {% for i in range(1, total_pages + 1) %}
        <a href="{{ url_for('app_routes.attempt_quiz', quiz_id=quiz.id, page=i) }}" 
           class="btn {% if i == page %}btn-primary{% else %}btn-outline-secondary{% endif %}" 
           style="min-width: 45px;">
          {{ i }}
        </a>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Wrap everything in a container with margin-top to ensure the content is visible -->
<div class="mt-3">
  <form method="POST">
    <h5 class="fs-4 text-white mb-3">Q{{ page }}: {{ question.question_statement }}</h5>
    {% if question.image_path %}
      <img src="{{ url_for('static', filename='uploads/' ~ question.image_path.split('/')[-1]) }}"
           alt="Question Image"
           class="img-fluid mb-3 rounded"
           style="max-height: 400px; object-fit: contain;">
    {% endif %}

    <!-- Display answer options -->
    {% if question.question_type == "single" %}
      <div class="form-check mb-2">
        <input class="form-check-input" type="radio" name="answer" value="option1" required>
        <label class="form-check-label text-white">{{ question.option1 }}</label>
      </div>
      <div class="form-check mb-2">
        <input class="form-check-input" type="radio" name="answer" value="option2">
        <label class="form-check-label text-white">{{ question.option2 }}</label>
      </div>
      {% if question.option3 %}
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="answer" value="option3">
          <label class="form-check-label text-white">{{ question.option3 }}</label>
        </div>
      {% endif %}
      {% if question.option4 %}
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="answer" value="option4">
          <label class="form-check-label text-white">{{ question.option4 }}</label>
        </div>
      {% endif %}

    {% elif question.question_type == "multiselect" %}
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" name="answer" value="option1">
        <label class="form-check-label text-white">{{ question.option1 }}</label>
      </div>
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" name="answer" value="option2">
        <label class="form-check-label text-white">{{ question.option2 }}</label>
      </div>
      {% if question.option3 %}
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" name="answer" value="option3">
          <label class="form-check-label text-white">{{ question.option3 }}</label>
        </div>
      {% endif %}
      {% if question.option4 %}
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" name="answer" value="option4">
          <label class="form-check-label text-white">{{ question.option4 }}</label>
        </div>
      {% endif %}

    {% elif question.question_type == "integer" %}
      <div class="mb-3">
        <input type="number" name="answer" class="form-control" placeholder="Enter your answer" required>
      </div>
    {% endif %}

    <!-- Navigation Buttons -->
    <div class="d-flex justify-content-between mt-4">
      {% if page > 1 %}
        <button type="submit" name="action" value="prev" class="btn btn-secondary">Previous</button>
      {% else %}
        <div></div>
      {% endif %}
      {% if page < total_pages %}
        <button type="submit" name="action" value="next" class="btn btn-primary">Next</button>
      {% else %}
        <button type="submit" name="action" value="submit" class="btn btn-success">Submit</button>
      {% endif %}
    </div>
  </form>
</div>

<script>
  // Get the end time from the server with null check
  let timeRemainingSeconds;
  {% if quiz.end_time %}
    const endTimeStr = "{{ quiz.end_time.strftime('%Y-%m-%dT%H:%M:%S') }}";
    const endTime = new Date(endTimeStr);
    const now = new Date();
    
    timeRemainingSeconds = Math.floor((endTime - now) / 1000);
    
    // If time is already up, redirect immediately
    if (timeRemainingSeconds <= 0) {
      document.getElementById('timeoutForm').submit();
    }
    
    // Update the timer display
    const timerEl = document.getElementById('quizTimer');
    
    function updateTimer() {
      if (timeRemainingSeconds <= 0) {
        timerEl.textContent = "00:00";
        // Submit the timeout form to server-side handler
        document.getElementById('timeoutForm').submit();
        return;
      }
      
      const minutes = Math.floor(timeRemainingSeconds / 60);
      const seconds = timeRemainingSeconds % 60;
      
      timerEl.textContent = 
        String(minutes).padStart(2, '0') + ":" + 
        String(seconds).padStart(2, '0');
      
      timeRemainingSeconds--;
    }
    
    // Update timer every second
    updateTimer();
    setInterval(updateTimer, 1000);
  {% else %}
    // If no end time is set, display a default timer (e.g., 60 minutes)
    timeRemainingSeconds = 60 * 60; // 60 minutes
    
    function updateTimer() {
      const minutes = Math.floor(timeRemainingSeconds / 60);
      const seconds = timeRemainingSeconds % 60;
      
      timerEl.textContent = 
        String(minutes).padStart(2, '0') + ":" + 
        String(seconds).padStart(2, '0');
      
      timeRemainingSeconds--;
      
      if (timeRemainingSeconds < 0) {
        document.getElementById('timeoutForm').submit();
      }
    }
    
    updateTimer();
    setInterval(updateTimer, 1000);
  {% endif %}
</script>
{% endblock %}
